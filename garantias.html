<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Garant√≠as</title>
    <link rel="stylesheet" href="style.css">
    <!-- Librer√≠as PDF necesarias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- Logo oculto para usar en el PDF -->
    <img id="pdf-logo" src="img/logo.png" style="display:none;" alt="Logo">

    <div class="container">
        <header>
            <img src="img/logo.png" alt="Logo" class="main-logo">
            <h1>Gesti√≥n de Garant√≠as</h1>
        </header>

        <main class="content-box">
            <h2>Formulario de Reclamaci√≥n</h2>
            <p>Rellena los datos y adjunta hasta 2 fotos. Se descargar√° un PDF que podr√°s enviarnos por correo.</p>
            
            <form id="warrantyForm" style="display:flex; flex-direction:column; gap:15px; text-align:left;">
                
                <div>
                    <label>Referencia del Producto:</label>
                    <input type="text" id="ref" class="qty-input" style="width:100%" required placeholder="Ej: 12345">
                </div>

                <div>
                    <label>N¬∫ Albar√°n / Factura:</label>
                    <input type="text" id="invoice" class="qty-input" style="width:100%" required placeholder="Ej: FA-2024-001">
                </div>

                <div>
                    <label>Descripci√≥n de la incidencia:</label>
                    <textarea id="reason" rows="4" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:5px;" required placeholder="Explica brevemente el problema..."></textarea>
                </div>

                <div style="background:#f9f9f9; padding:10px; border-radius:5px;">
                    <label style="font-weight:bold;">üì∏ Adjuntar Fotos (M√°x 2):</label>
                    <br><br>
                    <label>Foto 1:</label>
                    <input type="file" id="img1" accept="image/*">
                    <br><br>
                    <label>Foto 2:</label>
                    <input type="file" id="img2" accept="image/*">
                </div>

                <button type="submit" class="download-button pdf" id="btn-generate">
                    üì• Generar y Descargar PDF
                </button>
            </form>

            <a href="index.html" class="back-link">‚Üê Volver al men√∫ principal</a>
        </main>
    </div>

    <!-- L√ìGICA PARA GENERAR EL PDF CON IM√ÅGENES -->
    <script>
        document.getElementById('warrantyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('btn-generate');
            const originalText = btn.textContent;
            btn.textContent = "Generando PDF...";
            btn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // 1. LOGO
                const logoElem = document.getElementById('pdf-logo');
                try {
                    doc.addImage(logoElem, 'PNG', 15, 10, 30, 10); // Ajustar tama√±o logo
                } catch(err) { console.log("Logo no cargado"); }

                // 2. T√çTULO Y FECHA
                doc.setFontSize(16);
                doc.text("FORMULARIO DE RECLAMACI√ìN", 195, 20, { align: 'right' });
                doc.setFontSize(10);
                doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 195, 26, { align: 'right' });

                // 3. DATOS DEL FORMULARIO
                const ref = document.getElementById('ref').value;
                const invoice = document.getElementById('invoice').value;
                const reason = document.getElementById('reason').value;

                doc.setFontSize(11);
                doc.text("DATOS DE LA INCIDENCIA:", 15, 45);
                
                doc.setFontSize(10);
                doc.text(`Referencia Producto:  ${ref}`, 15, 55);
                doc.text(`N¬∫ Factura/Albar√°n:   ${invoice}`, 15, 62);
                
                doc.text("Descripci√≥n del problema:", 15, 72);
                // Dividir texto largo para que no se salga
                const splitReason = doc.splitTextToSize(reason, 180); 
                doc.text(splitReason, 15, 78);

                let currentY = 78 + (splitReason.length * 5) + 10;

                // 4. PROCESAR IM√ÅGENES (Funci√≥n auxiliar)
                const readImage = (input) => {
                    if (input.files && input.files[0]) {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(input.files[0]);
                        });
                    }
                    return Promise.resolve(null);
                };

                const img1Data = await readImage(document.getElementById('img1'));
                const img2Data = await readImage(document.getElementById('img2'));

                // 5. A√ëADIR IM√ÅGENES AL PDF
                if (img1Data || img2Data) {
                    doc.text("EVIDENCIAS FOTOGR√ÅFICAS:", 15, currentY);
                    currentY += 10;

                    // Tama√±o fotos: 80x60 mm aprox
                    if (img1Data) {
                        doc.addImage(img1Data, 'JPEG', 15, currentY, 80, 60);
                        if (img2Data) {
                            doc.addImage(img2Data, 'JPEG', 105, currentY, 80, 60);
                        }
                    } else if (img2Data) {
                        doc.addImage(img2Data, 'JPEG', 15, currentY, 80, 60);
                    }
                }

                // 6. GUARDAR
                doc.save(`Reclamacion_${ref}.pdf`);
                alert("PDF Generado correctamente. Por favor, env√≠alo por correo a tu comercial.");

            } catch (error) {
                console.error(error);
                alert("Error al generar el PDF. Intenta usar im√°genes JPG/PNG m√°s ligeras.");
            }

            btn.textContent = originalText;
            btn.disabled = false;
        });
    </script>
</body>
</html>