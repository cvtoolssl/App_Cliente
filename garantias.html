<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Garant√≠as</title>
    <link rel="stylesheet" href="style.css">
    <!-- Librer√≠a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <!-- Logo oculto para PDF -->
    <img id="pdf-logo" src="img/logo.png" style="display:none;" alt="Logo">

    <div class="container">
        <header>
            <div class="header-logos">
                <img src="img/logo.png" alt="Logo" class="client-logo">
                <img src="img/cvtools.png" alt="CV Tools" class="provider-logo">
            </div>
            <h1>Gesti√≥n de Garant√≠as</h1>
        </header>

        <main class="content-box">
            <p style="margin-bottom:20px;">Rellena los datos de la incidencia. Generaremos un PDF con las im√°genes adjuntas listo para enviar.</p>
            
            <!-- FORMULARIO ESTILIZADO -->
            <form id="warrantyForm" class="warranty-form">
                
                <div class="form-group">
                    <label for="ref">Referencia del Producto:</label>
                    <input type="text" id="ref" class="form-input" required placeholder="Ej: 12345-X">
                </div>

                <div class="form-group">
                    <label for="invoice">N¬∫ Albar√°n / Factura:</label>
                    <input type="text" id="invoice" class="form-input" required placeholder="Ej: FA-2024-001">
                </div>

                <div class="form-group">
                    <label for="reason">Descripci√≥n de la incidencia:</label>
                    <textarea id="reason" rows="5" class="form-textarea" required placeholder="Describe brevemente qu√© le ocurre al producto..."></textarea>
                </div>

                <!-- √Årea de fotos mejorada -->
                <div class="upload-area">
                    <h4>üì∏ Evidencias Fotogr√°ficas</h4>
                    <div class="file-input-wrapper">
                        <label style="font-size:0.9em; display:block; margin-bottom:5px;">Foto 1 (Producto completo):</label>
                        <input type="file" id="img1" accept="image/*" style="width:100%">
                    </div>
                    <div class="file-input-wrapper">
                        <label style="font-size:0.9em; display:block; margin-bottom:5px;">Foto 2 (Detalle del fallo):</label>
                        <input type="file" id="img2" accept="image/*" style="width:100%">
                    </div>
                </div>

                <button type="submit" class="download-button pdf" id="btn-generate" style="margin-top:10px;">
                    üì• Generar y Descargar PDF
                </button>
            </form>

            <a href="index.html" class="back-link" style="margin-top:30px;">‚Üê Volver al men√∫ principal</a>
        </main>
    </div>

    <!-- Script de generaci√≥n de PDF -->
    <script>
        document.getElementById('warrantyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('btn-generate');
            const originalText = btn.textContent;
            btn.textContent = "‚è≥ Procesando im√°genes...";
            btn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // 1. Cabecera PDF
                const logoElem = document.getElementById('pdf-logo');
                try { doc.addImage(logoElem, 'PNG', 15, 10, 30, 10); } catch(err){}

                doc.setFontSize(16);
                doc.text("HOJA DE RECLAMACI√ìN", 195, 20, { align: 'right' });
                doc.setFontSize(10);
                doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 195, 26, { align: 'right' });

                // 2. Datos
                const ref = document.getElementById('ref').value;
                const invoice = document.getElementById('invoice').value;
                const reason = document.getElementById('reason').value;

                doc.setFont("helvetica", "bold");
                doc.text("DATOS DE LA INCIDENCIA:", 15, 45);
                doc.setFont("helvetica", "normal");
                
                doc.text(`Producto (Ref):`, 15, 55); 
                doc.text(ref, 60, 55);
                
                doc.text(`Documento (Fac/Alb):`, 15, 62);
                doc.text(invoice, 60, 62);
                
                doc.text("Motivo:", 15, 75);
                const splitReason = doc.splitTextToSize(reason, 180); 
                doc.text(splitReason, 15, 82);

                let currentY = 82 + (splitReason.length * 5) + 10;

                // 3. Im√°genes
                const readImage = (input) => {
                    if (input.files && input.files[0]) {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(input.files[0]);
                        });
                    }
                    return Promise.resolve(null);
                };

                const img1Data = await readImage(document.getElementById('img1'));
                const img2Data = await readImage(document.getElementById('img2'));

                if (img1Data || img2Data) {
                    doc.line(15, currentY - 5, 195, currentY - 5);
                    doc.setFont("helvetica", "bold");
                    doc.text("FOTOS ADJUNTAS:", 15, currentY + 5);
                    currentY += 15;

                    // Ajuste para que quepan bien
                    const imgWidth = 80;
                    const imgHeight = 60;

                    if (img1Data) {
                        doc.addImage(img1Data, 'JPEG', 15, currentY, imgWidth, imgHeight);
                        doc.text("Foto 1", 15, currentY + imgHeight + 5);
                        if (img2Data) {
                            doc.addImage(img2Data, 'JPEG', 110, currentY, imgWidth, imgHeight);
                            doc.text("Foto 2", 110, currentY + imgHeight + 5);
                        }
                    } else if (img2Data) {
                        doc.addImage(img2Data, 'JPEG', 15, currentY, imgWidth, imgHeight);
                    }
                }

                doc.save(`Reclamacion_${ref.replace(/[^a-z0-9]/gi, '_')}.pdf`);
                alert("‚úÖ PDF descargado. Ahora puedes enviarlo por correo.");

            } catch (error) {
                console.error(error);
                alert("Hubo un error al generar el PDF. Prueba con im√°genes m√°s peque√±as.");
            }

            btn.textContent = originalText;
            btn.disabled = false;
        });
    </script>
</body>
</html>